# DlgIntro.cpp / .h (CDlgIntro)

初回起動時に表示される使い方の案内用のダイアログです。処理内容は簡素な作りです。ソースの流れを順に追うだけでも十分です。

## リソース (VisualScript.rc)
* IDD_INTRO: ダイアログ (Tutorial)
* IDC_TUTORIAL: ラジオボタン (Go to the tutorial)
* IDC_TUTORIAL_FILE: ラジオボタン (Open the sample script)
* IDC_DONT_SHOW: チェックボックス (Don't show this again)
* IDS_SAMPLE_SCRIPT: Till Death Do Us Part.sws

## 変数
* m_radio: ラジオボタンの開始位置 (初期値: -1)
* m_dontShow: CDlgIntro ダイアログの表示・非表示 (初期値: FALSE)
* m_file: サンプルの脚本ファイル名 (初期値: Till Death Do Us Part.sws)
* fs: ファイルステータス
* haveFile: ファイルの存在確認

## MFC / Win32 API
* CFile
* CFileStatus
* CDialog
* EnableWindow
* GetDlgItem
* LoadString
* UpdateData
* WinHelp
* WriteProfileInt

## サンプルスクリプトがない場合の処理 - CDlgIntro::OnInitDialog() 

解説を要するのはここくらいかな。

``` cpp
CString name;

	name.LoadString ( IDS_SAMPLE_SCRIPT );

	if ( name.IsEmpty ( ) )

		name = "Till Death Do Us Part.sws";

	m_file = theApp.m_scriptDir + name;

	CFileStatus fs;

	BOOL haveFile = CFile::GetStatus ( m_file, fs );
//中略
	if ( ! haveFile )

		GetDlgItem ( IDC_TUTORIAL_FILE )->EnableWindow ( FALSE );
```

1. LoadStringでリソースファイルからリソース文字列としてサンプルスクリプトファイルの名前を取得する。取得できなければフェイルセーフとしてサンプルスクリプトのファイル名を設定し直す。
2. m_fileではスクリプトのディレクトリ名とサンプルスクリプトファイルの名前を連結して m_fileに代入してから存在確認のために CFile::GetStatus に渡した結果を得る。正常に存在確認されていれば返値は TRUE (fs はCFileStaus構造体) です。
3. サンプルスクリプトが見つからないときは、該当リソースのラジオボタンをグレードアウトしてダイアログでは選択禁止にする。
4. この書き方は不明瞭、冗長なので Windowsx.h をインクルードして関数や Button_Enabled, Edit_Enable マクロで制御したほうがスッキリするような。

## チェックボックスの処理分岐

ここでチェックボックスの付け外しの処理です。DDX使用時は判定用のプログラムを書き足す必要はないようです。
``` cpp
DDX_Check(pDX, IDC_DONT_SHOW, m_dontShow);
```

dontは 〜しないなので外されているときは TRUE になる。その場合のみ WriteProfileInt 関数を使ってエントリ(Show, Tutorial)に FALSE を書きこむ (FALSEになったら該当エントリを少し手間のかかる方法で削除しない限りは再表示されなくなる仕様です)。

それと、ソースコードにおいて肯定形と否定形の併用は混乱の元です。  m_dontShow は命名規則として二重否定になるのでダメです。リファクタリング行きです。やるなら showAgainDialog showThisAgain のほうがマシです。まあ、ローカルメンバー変数ですので仰々しい名前はいらないと思います。

## 非互換部分 (Windows Vista 以降)

この部分に限らず WinHelp / MFC 関数および hlp ファイル使用部分は書き換え対象です(about.cpp, frame.cpp, VisualScript.cpp, DlgIntro.cpp)。

* hlpfile
* m_pszHelpFilePath: アプリケーションのヘルプファイルのパスを指定 (CWinApp クラス)
* ID_HELP_FINDER
* ID_DEFAULT_HELP
* CMDIFrameWnd::OnHelpFinder (CWnd / CMDIFrameWndから継承)

## 呼び出し元 (VisualScript.cpp: 635 - 643)

``` cpp
	// the tutorial

	Log ( "Show tool tips" );

	if ( GetProfileInt ( "Show", "Tutorial", TRUE ) )

	  {

		CDlgIntro dlg ( pMainFrame );

	  dlg.DoModal ( );

	  }

	else

		ShowTipAtStartup();
```

if と GetProfileInt だけ読むと特筆するところもないかな。親ウィンドウに重ねて表示するのはモーダルダイアログなんで pMainFrame をポインタ引数として渡してインスタンス作るのは別に不自然でもないけどね。


## 疑問点
*  m_radio の初期値は -1 なのか？→調べたけどちょっとわからない。ラジオボタンで返される通常値は 0 以上です。OnInitDialog() では 0 に設定されるので、 -1 にしておけば異常発生時にアサーションで捕まえられるかもしれないね。

* m_dontShow はコンストラクタで FALSE である。だが、呼び出し元では初回起動時は TRUE 扱いのようだ。どうしてこうなのか？ → Win32 API の GetProfileInt はセクション(第一引数:lpAppName)とキー(第二引数:lpKeyName)が存在しない場合は第三引数(nDefault)を返値とするので初回起動時でも TRUE になる。その後、CDlgIntroで該当セクションとキーを設定する仕様です。Windowsインストーラーのスクリプトファイル(拡張子はwse)には存在しません。うん。紛らわしい。わからないときはすぐに grep するんじゃなくて、数秒考えてから APIリファレンスを読もう。

## その他

毎月、ダイアログ二種類、後半でモデル側のコードを解析するって感じで六ファイルほど進められたらいいです。慣れてきたら無理のない範囲で作業量増やしますが、年末までに残り30ファイル以下まで減っていたら御の字でしょうね。

今月からは年単位で取り組む翻訳プロジェクトやコードリーディングもありますんで Page2Stage の進捗は遅くなるかもしれません。楽しみにしている人は実在しないので問題はなさそうです。
